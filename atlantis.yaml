version: 3
automerge: true
projects:
  - name: traffic-tacos
    dir: .
    autoplan:
      when_modified: ["*.tf", "*.tfvars", "modules/**/*.tf"]
      enabled: true
    workflow: terraform-infracost

workflows:
  terraform-infracost:
    plan:
      steps:
        - init
        - plan
        - env:
            name: INFRACOST_API_KEY
            value: "${INFRACOST_API_KEY}"
        - env:
            name: INFRACOST_CURRENCY
            value: "${INFRACOST_CURRENCY}"
        - env:
            name: INFRACOST_AWS_OVERRIDE_REGION
            value: ap-northeast-2
        - run: |
            echo "=== π’° Infracost λΉ„μ© λ¶„μ„ ==="
            echo "ν„μ¬ μΈν”„λΌ λΉ„μ©:"
            infracost breakdown --path . --format json
            echo ""
            echo "λ³€κ²½μ‚¬ν•­μΌλ΅ μΈν• λΉ„μ© μ°¨μ΄:"
            infracost diff --path . --compare-to /dev/null --format diff
            echo "=== λΉ„μ© λ¶„μ„ μ™„λ£ ==="
    apply:
      steps:
        - apply